<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>24 Game</title>
  <style>
    :root {
      --bg: #0b0f14;
      --bg-soft: #10161d;
      --card: #131a22;
      --card-edge: #1f2a36;
      --text: #e6edf3;
      --muted: #8ea1b2;
      --accent: #4f86ff;
      --accent-2: #19d3da;
      --danger: #ff6b6b;
      --ok: #7dffb3;
      --shadow: rgba(0,0,0,.5);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 800px at 50% -10%, #10161d, var(--bg));
      color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      display: grid; place-items: center; padding: 24px;
    }

    .app { width: 100%; max-width: 920px; display: grid; gap: 18px; }

    header {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      background: linear-gradient(180deg, #0f141b 0%, #0b0f14 100%);
      border: 1px solid #1a2330; padding: 14px 16px; border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow), inset 0 1px 0 rgba(255,255,255,.03);
    }
    header h1 { font-size: 20px; margin: 0; letter-spacing: .4px; font-weight: 650; }

    .actions { display:flex; gap:10px; flex-wrap: wrap; }
    .btn {
      appearance: none; border: 1px solid #213247; background: #0f1520; color: var(--text);
      padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .btn:hover { border-color: #2b405a; box-shadow: 0 10px 26px rgba(0,0,0,.45); }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn.primary { background: linear-gradient(180deg, #183152, #12263d); border-color: #214167; }
    .btn.accent { background: linear-gradient(180deg, #2a3b66, #203054); border-color: #39528a; }

    .table {
      background: linear-gradient(180deg, var(--bg-soft), #0e141b);
      border: 1px solid #1a2330; border-radius: 16px; padding: 28px; display: grid;
      gap: 18px; box-shadow: inset 0 1px 0 rgba(255,255,255,.025), 0 20px 50px rgba(0,0,0,.55);
    }

    .cards { display: grid; grid-template-columns: repeat(4, minmax(90px, 1fr)); gap: 16px; place-items: center; }

    .card {
      width: 100%; aspect-ratio: 5/7; background: radial-gradient(280px 200px at 50% 20%, #1b2633 0%, #0f1621 70%);
      border-radius: 16px; border: 1px solid var(--card-edge); color: var(--text);
      display: grid; place-items: center; position: relative; isolation: isolate;
      box-shadow: 0 14px 40px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.04);
      transform: translateY(0); transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 18px 50px rgba(0,0,0,.66); }

    .pip { font-size: clamp(34px, 6vw, 44px); font-weight: 800; letter-spacing: .5px; }

    .io { display: grid; gap: 10px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }

    input[type="text"], input[type="password"] {
      width: 100%; background: #0f1520; color: var(--text);
      border: 1px solid #1f2b3b; border-radius: 12px; padding: 12px 14px; font-size: 15px;
      outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    input[type="text"]:focus, input[type="password"]:focus { border-color: #33537a; box-shadow: 0 0 0 2px rgba(79,134,255,.15); }

    .status { padding: 12px 14px; border-radius: 12px; border: 1px solid #1f2b3b; background: #0f1520; min-height: 46px; }
    .status.ok { border-color: rgba(125,255,179,.35); }
    .status.err { border-color: rgba(255,107,107,.35); }

    /* Co-op status bar */
    .coopbar {
      display: none;
      background: #0f1520;
      border: 1px solid #1f2b3b;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      justify-content: space-between;
      gap: 12px;
    }
    .coopbar.show { display: flex; }

    /* Scoreboard (Versus) */
    .scoreboard {
      display: none;
      background: #0f1520;
      border: 1px solid #1f2b3b;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    .scoreboard.show { display: block; }
    .score-item {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 2px 0;
      gap: 8px;
    }
    .score-item .name { font-weight: 600; }
    .score-item .score {
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      padding-left: 8px;
    }

    footer { color: var(--muted); font-size: 13px; text-align: center; opacity: .9; }

    @media (max-width: 560px) {
      .cards { grid-template-columns: repeat(2, minmax(90px, 1fr)); }
    }

    /* Modal (Multiplayer) */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      place-items: center;
      z-index: 1000;
    }
    .modal.active { display: grid; }
    .modal-content {
      width: min(520px, 92vw);
      background: linear-gradient(180deg, #0f141b 0%, #0b0f14 100%);
      border: 1px solid #1a2330; border-radius: 14px; padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      display: grid; gap: 12px;
    }
    .modal-content h2 { margin: 0 0 4px; font-size: 18px; }
    .modal .group { display: grid; gap: 10px; }
    .modal .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .modal .modal-actions { text-align: right; }
    .modal label { font-size: 12px; color: var(--muted); }

    /* Segmented control (mode switch) */
    .segmented { display:inline-flex; border:1px solid #1a2330; border-radius:10px; overflow:hidden; }
    .segmented .btn { border:none; border-radius:0; padding:8px 12px; background:#0f1520; }
    .segmented .btn.active { background:linear-gradient(180deg, #2a3b66, #203054); }
    .segmented .btn:not(.active):hover { background:#0f1826; }

    /* Tabs */
    .tabs { display:grid; gap:10px; }
    .tab-list { display:flex; gap:8px; }
    .tab-btn { padding:8px 12px; border:1px solid #1a2330; background:#0f1520; color:var(--text); border-radius:8px; cursor:pointer; }
    .tab-btn.active { background:linear-gradient(180deg, #2a3b66, #203054); border-color:#39528a; }
    .tab-panel { display:none; }
    .tab-panel.active { display:grid; gap:10px; }
  </style>
</head>
<body>
  <div id="main" class="app">
    <header>
      <h1>24 Game</h1>
      <div class="actions">
        <button id="regen" class="btn primary">Regenerate</button>
        <button id="settingsBtn" class="btn">Multiplayer</button>
        <button id="shuffle" class="btn">Shuffle Hand</button>
        <button id="toggle" class="btn">Toggle Labels</button>
      </div>
    </header>

    <div id="coopBar" class="coopbar" aria-live="polite">
      <span>⏱ <span id="coopTime">00:00</span></span>
      <span>✅ Correct: <span id="coopCorrect">0</span></span>
    </div>

    <!-- Versus Scoreboard -->
    <div id="scoreBoard" class="scoreboard" role="region" aria-label="Scoreboard" aria-live="polite">
      <div id="scoreItems"></div>
    </div>

    <section class="table">
      <div id="cards" class="cards" aria-live="polite"></div>
      <div class="io">
        <div class="row">
          <input id="expr" type="text" placeholder="Type your expression, e.g. (6/(1-3/4))" aria-label="Your expression" />
          <button id="check" class="btn accent">Check</button>
        </div>
        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </section>

    <footer>Use numbers exactly once. Allowed operators: + − × ÷ and parentheses. A=1, J=11, Q=12, K=13.</footer>
  </div>

  <!-- Multiplayer modal -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <h2 id="settingsTitle">Multiplayer</h2>

      <div class="tabs">
        <div class="tab-list" role="tablist">
          <button id="tabJoinBtn" class="tab-btn active" role="tab" aria-selected="true" aria-controls="joinPanel">Join</button>
          <button id="tabCreateBtn" class="tab-btn" role="tab" aria-selected="false" aria-controls="createPanel">Create</button>
        </div>

        <!-- Join tab -->
        <div id="joinPanel" class="tab-panel active" role="tabpanel">
          <div class="group">
            <div>
              <label for="nameJoin">Name</label>
              <input id="nameJoin" type="text" placeholder="Your name (e.g., theory2468)" />
            </div>
            <div>
              <label for="roomJoin">Room ID</label>
              <input id="roomJoin" type="text" placeholder="Room ID (e.g., Nukebommer's lobby)" />
            </div>
            <div>
              <label for="passwordJoin">Password</label>
              <input id="passwordJoin" type="password" placeholder="Room password" />
            </div>
            <div class="row-2">
              <button id="join" class="btn primary">Join</button>
              <button id="leave" class="btn">Leave</button>
            </div>
          </div>
        </div>

        <!-- Create tab -->
        <div id="createPanel" class="tab-panel" role="tabpanel" aria-hidden="true">
          <div class="group">
            <div>
              <label for="nameCreate">Name</label>
              <input id="nameHost" type="text" placeholder="Your name (e.g., shoie)" />
            </div>
            <div>
              <label for="roomCreate">Room ID</label>
              <input id="roomCreate" type="text" placeholder="Room ID (e.g., bell's lobby)" />
            </div>
            <div>
              <label for="passwordCreate">Password</label>
              <input id="passwordCreate" type="password" placeholder="Room password" />
            </div>
            <div>
              <label>Mode (create only)</label>
              <div class="segmented" role="group" aria-label="Multiplayer mode">
                <button id="modeVersus" class="btn active" aria-pressed="true">Versus</button>
                <button id="modeCoop" class="btn" aria-pressed="false">Co-op</button>
              </div>
            </div>
            <div class="row-2">
              <button id="createRoom" class="btn">Create Room</button>
              <span></span>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button id="closeSettings" class="btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = "https://two4game.onrender.com";
    const WS_URL = "https://two4game.onrender.com/ws";
    let ws = null;
    let inVersus = false;
    let useFaceCards = true;
    let currentNums = [];

    // Mode selected for CREATE only
    let gameMode = 'versus';
    // Mode of the active connection (set by server on state)
    let activeMode = null;

    // Co-op UI state
    let coopTimer = null;
    let coopStartMs = 0;
    let coopCorrect = 0;

    // Modal refs
    const modal = document.getElementById('settingsModal');

    // API helper
    async function api(path, opts) {
      const res = await fetch(`${API}${path}`, { headers: { 'Content-Type': 'application/json' }, ...opts });
      if (!res.ok) throw new Error((await res.text()) || res.statusText);
      return res.json();
    }

    const rankToLabel = (n) => ({11:'J',12:'Q',13:'K',1:'A'}[n] || String(n));

    function renderCards(nums) {
      currentNums = nums;
      const container = document.getElementById('cards');
      container.innerHTML = '';
      nums.forEach((n) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-value', n);
        const label = useFaceCards ? rankToLabel(n) : String(n);
        card.innerHTML = `<div class="pip">${label}</div>`;
        container.appendChild(card);
      });
    }

    function fillInputsFromCards() { return currentNums; }

    function setStatus(text, ok=null) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.classList.remove('ok','err');
      if (ok === true) el.classList.add('ok');
      if (ok === false) el.classList.add('err');
    }

    // Co-op helpers
    function showCoopBar(show) { document.getElementById('coopBar').classList.toggle('show', !!show); }
    function fmtTime(ms) {
      const total = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(total/60)).padStart(2,'0');
      const s = String(total%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function updateCoopTime() { document.getElementById('coopTime').textContent = fmtTime(Date.now() - coopStartMs); }
    function startCoopTimer(startMs) {
      stopCoopTimer();
      coopStartMs = typeof startMs === 'number' ? startMs : Date.now();
      updateCoopTime();
      coopTimer = setInterval(updateCoopTime, 1000);
    }
    function stopCoopTimer() { if (coopTimer) { clearInterval(coopTimer); coopTimer = null; } }
    function resetCoopStats() {
      coopCorrect = 0;
      document.getElementById('coopCorrect').textContent = String(coopCorrect);
      stopCoopTimer();
      document.getElementById('coopTime').textContent = '00:00';
    }

    async function newPuzzle() {
      if (inVersus) { setStatus('In multiplayer mode. No cheating :)'); return; }
      setStatus('Generating puzzle…');
      const res = await fetch(`${API}/puzzle`);
      const json = await res.json();
      renderCards(json.nums);
      document.getElementById('expr').value = '';
      setStatus('New hand dealt. Good luck!');
    }

    async function checkExpression() {
      const expression = document.getElementById('expr').value.trim();
      if (!expression) { setStatus('Enter an expression to check.'); return; }
      if (inVersus && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'attempt', expression }));
        return;
      }
      setStatus('Checking…');
      const res = await fetch(`${API}/check`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nums: fillInputsFromCards(), expression })
      });
      const json = await res.json();
      setStatus((json.ok ? '✅ ' : '❌ ') + json.message, json.ok);
    }

    function toggleLabels() { useFaceCards = !useFaceCards; renderCards(currentNums); }

    function shuffleCards() {
      if (!currentNums || currentNums.length === 0) return;
      const nums = currentNums.slice();
      for (let i = nums.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [nums[i], nums[j]] = [nums[j], nums[i]];
      }
      renderCards(nums);
      setStatus('Cards shuffled.');
    }

    // Small util to escape text for HTML injection safety
    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Scoreboard helpers (Versus)
    function showScoreboard(show) {
      document.getElementById('scoreBoard').classList.toggle('show', !!show);
      if (!show) document.getElementById('scoreItems').innerHTML = '';
    }
    function renderScoreboard(players) {
      const list = document.getElementById('scoreItems');
      if (!Array.isArray(players)) { list.innerHTML = ''; return; }
      const sorted = players.slice().sort((a, b) =>
        (b.score || 0) - (a.score || 0) || String(a.name || '').localeCompare(String(b.name || ''))
      );
      list.innerHTML = sorted.map((p, i) =>
        `<div class="score-item"><div class="name">${i + 1}. ${escapeHtml(p.name || 'Player')}</div><div class="score">${p.score ?? 0}</div></div>`
      ).join('');
    }

    // Tabs
    function setTab(tab) {
      const joinBtn = document.getElementById('tabJoinBtn');
      const createBtn = document.getElementById('tabCreateBtn');
      const joinPanel = document.getElementById('joinPanel');
      const createPanel = document.getElementById('createPanel');
      const isJoin = tab === 'join';
      joinBtn.classList.toggle('active', isJoin);
      createBtn.classList.toggle('active', !isJoin);
      joinBtn.setAttribute('aria-selected', String(isJoin));
      createBtn.setAttribute('aria-selected', String(!isJoin));
      joinPanel.classList.toggle('active', isJoin);
      createPanel.classList.toggle('active', !isJoin);
      createPanel.setAttribute('aria-hidden', String(isJoin));
      joinPanel.setAttribute('aria-hidden', String(!isJoin));
      setTimeout(() => { (isJoin ? document.getElementById('nameJoin') : document.getElementById('roomCreate')).focus(); }, 0);
    }

    // Modal controls
    function openSettings() { setTab('join'); modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); }
    function closeSettings() { modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }

    // Shared: acquire a join token (tries without mode, then preferred and fallback)
    async function requestJoinToken(name, room, password, preferredMode) {
      async function tryJoin(body) {
        const res = await fetch(`${API}/rooms/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const text = await res.text();
        return { ok: res.ok, status: res.status, data: res.ok ? JSON.parse(text) : null };
      }

      let tokenData = null;

      // First try without mode (server may infer)
      try {
        const r0 = await tryJoin({ room, password, name });
        if (r0.ok) tokenData = r0.data;
        else if (r0.status === 403) throw new Error('Invalid password.');
      } catch {}

      // Then try preferred mode first (if provided), then the other(s)
      if (!tokenData) {
        const modes = preferredMode
          ? [preferredMode, preferredMode === 'coop' ? 'versus' : 'coop']
          : ['versus', 'coop'];
        for (const m of modes) {
          const r = await tryJoin({ room, password, name, mode: m });
          if (r.ok) { tokenData = r.data; break; }
          if (r.status === 403) throw new Error('Invalid password.');
        }
      }

      if (!tokenData) throw new Error('Room not found.');
      return tokenData.token;
    }

    // Shared WS connector
    function connectWS(token) {
      ws = new WebSocket(`${WS_URL}?token=${encodeURIComponent(token)}`);

      ws.onopen = () => {
        inVersus = true;
        activeMode = null;
        resetCoopStats();
        showScoreboard(false); // will be shown when state arrives if versus
        setStatus('Connected. Wait for the puzzle…');
      };
      ws.onclose = () => {
        inVersus = false;
        ws = null;
        activeMode = null;
        showCoopBar(false);
        showScoreboard(false);
        resetCoopStats();
        setStatus('Disconnected from room.');
        newPuzzle();
      };
      ws.onerror = () => setStatus('WebSocket error.', false);
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          switch (msg.type) {
            case 'state': {
              const m = (msg.mode === 'coop') ? 'coop' : 'versus';
              const changed = activeMode !== m;
              activeMode = m;

              if (activeMode === 'coop') {
                showCoopBar(true);
                showScoreboard(false);
                if (typeof msg.teamCorrect === 'number') {
                  coopCorrect = msg.teamCorrect;
                  document.getElementById('coopCorrect').textContent = String(coopCorrect);
                }
                if (changed) { stopCoopTimer(); document.getElementById('coopTime').textContent = '00:00'; }
              } else {
                showCoopBar(false);
                showScoreboard(true);
                if (Array.isArray(msg.players)) renderScoreboard(msg.players);
              }
              break;
            }
            case 'puzzle':
              if (Array.isArray(msg.nums)) {
                document.getElementById('expr').value = '';
                renderCards(msg.nums);
                setStatus(activeMode === 'coop' ? 'New co-op round!' : 'New round. Be the first!');
                if (activeMode === 'coop') {
                  const startMs = typeof msg.startedAt === 'number' ? msg.startedAt : undefined;
                  startCoopTimer(startMs);
                }
              }
              break;
            case 'attemptResult':
              setStatus((msg.ok ? '✅ ' : '❌ ') + (msg.message || ''), msg.ok === true);
              break;
            case 'solved':
              if (activeMode === 'coop') {
                if (typeof msg.teamCorrect === 'number') coopCorrect = msg.teamCorrect;
                else coopCorrect += 1;
                document.getElementById('coopCorrect').textContent = String(coopCorrect);
                stopCoopTimer();
              }
              setStatus(`${msg.message || 'Solved!'}${msg.expression ? ' Expression: ' + msg.expression : ''}`);
              if (activeMode === 'versus' && Array.isArray(msg.players)) {
                renderScoreboard(msg.players);
              }
              break;
          }
        } catch {}
      };
    }

    // Create (host picks mode)
    async function createRoom() {
      const name = (document.getElementById('nameHost').value || '').trim() || 'Host';
      const room = document.getElementById('roomCreate').value.trim();
      const password = document.getElementById('passwordCreate').value;
      if (!room) { setStatus('Enter a room ID.', false); return; }
      if (!password) { setStatus('Password must be used.', false); return; }
      if (ws && ws.readyState === WebSocket.OPEN) { setStatus('Already in multiplayer. Leave first.', false); return; }
      try {
        await api('/rooms', { method:'POST', body: JSON.stringify({ room, mode: gameMode, password }) });
        setStatus(`Room "${room}" (${gameMode}) created. Connecting…`);

        // Auto-join as host using nameHost
        const token = await requestJoinToken(name, room, password, gameMode);
        connectWS(token);
        closeSettings();

        // Optional: prefill Join tab for visibility
        document.getElementById('roomJoin').value = room;
        setTab('join');
      } catch (e) {
        setStatus(String(e.message || e), false);
      }
    }

    // Join (mode decided by host)
    async function joinVersus() {
      const name = document.getElementById('nameJoin').value.trim() || 'Player';
      const room = document.getElementById('roomJoin').value.trim();
      const password = document.getElementById('passwordJoin').value;
      if (!room) { setStatus('Enter a room ID.', false); return; }
      if (!password) { setStatus('Enter the room password.', false); return; }
      if (ws && ws.readyState === WebSocket.OPEN) { setStatus('Already in multiplayer.'); closeSettings(); return; }

      setStatus(`Joining room "${room}"…`);
      try {
        const token = await requestJoinToken(name, room, password, null);
        connectWS(token);
        closeSettings();
      } catch (e) {
        setStatus(String(e.message || e), false);
      }
    }

    function leaveVersus() { if (ws) ws.close(); }

    // Mode toggle (create-only)
    function setMode(mode) {
      gameMode = mode === 'coop' ? 'coop' : 'versus';
      const v = document.getElementById('modeVersus');
      const c = document.getElementById('modeCoop');
      const vActive = gameMode === 'versus';
      v.classList.toggle('active', vActive);
      c.classList.toggle('active', !vActive);
      v.setAttribute('aria-pressed', String(vActive));
      c.setAttribute('aria-pressed', String(!vActive));
    }

    // Listeners
    document.getElementById('regen').addEventListener('click', newPuzzle);
    document.getElementById('toggle').addEventListener('click', toggleLabels);
    document.getElementById('check').addEventListener('click', checkExpression);
    document.getElementById('shuffle').addEventListener('click', shuffleCards);

    document.getElementById('settingsBtn').addEventListener('click', () => { openSettings(); });
    document.getElementById('closeSettings').addEventListener('click', closeSettings);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeSettings(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSettings(); });

    document.getElementById('tabJoinBtn').addEventListener('click', () => setTab('join'));
    document.getElementById('tabCreateBtn').addEventListener('click', () => setTab('create'));

    document.getElementById('createRoom').addEventListener('click', createRoom);
    document.getElementById('join').addEventListener('click', joinVersus);
    document.getElementById('leave').addEventListener('click', leaveVersus);
    document.getElementById('modeVersus').addEventListener('click', () => setMode('versus'));
    document.getElementById('modeCoop').addEventListener('click', () => setMode('coop'));

    document.getElementById('expr').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); checkExpression(); }
    });

    // Initial hand
    newPuzzle();
  </script>
</body>
</html>